<article>
<title>XMPP/Jabber</title>

<p>Ciekawą i interesującą usługą jest Instant Message, a konkretniej protokół <wiki pl="Extensible Messaging and Presence Protocol">XMPP</wiki>. O protokole tym i jego bolączkach wieku dziecięcego wspomniałem już <id_link id="ABC_OF_COMPUTING:networks:IP_network_services:xmpp">wcześniej</id_link>.</p>

<p>Główna bolączką XMPP wydaje się być opóźnienie implementacji w stosunku co do standardów. W przypadku serwerów nie jest bardzo tragicznie (większość funkcjonalności jest dostępna w formie dodatkowych modułów lub łatek), natomiast w przypadku klientów braki są liczniejsze (tutaj jednak zawsze można sobie poradzić komunikując się z nieobsługiwaną w kliencie funcjonalnością przy pomocy konsoli XML).</p>

<p>Najciekawszym w chwili obecnej serwerem tej usługi wydaje się być <homepage url="http://ejabberd.im/">ejabberd</homepage>. Zamieszczam jego przykładową konfigurację - <a class="int" href="ejabberd.cfg">ejabberd.cfg</a>.</p>

<p>Warto zainteresować się również łatkami do tego serwera zwiększającymi jego funkcjonalność <homepage url="http://www.ndl.kiev.ua/content/mod_archive_odbc-release">mod_archive_odbc-release</homepage>, dodającym implementację Message Archiving (XEP-0136), jest także jego nowsza wersja pod nazwą <homepage url="http://ejabberd.im/mod_archive2">mod_archive2</homepage> (wersja odbc używana z PSQL 8.4.12 i erland R14 może wymagać załatania mod_archive_webview - spodziewa się tekstowej postaci czasu UTC, ale otrzymuje z bazy postać numeryczną - <a class="int" href="[[!URLPREFIX!]]/archiwum/materialy_publikowane_gdzieindziej/Patches/mod_archive_webview.diff">patch mojego autorstwa</a>).
	Kolejnym ciekawym patchem jest <homepage url="http://ejabberd.im/mod_multicast">mod_multicast</homepage> implementujący wieloadresowanie Extended Stanza Addressing (XEP-0033) oraz patcjh implementujący <homepage url="https://support.process-one.net/browse/EJAB-449">XEP-0079: Advanced Message Processing</homepage>.
	Zainteresować się można również patch'ami umożliwiającymi: <homepage url="http://ejabberd.im/ejabberd_ircd">dostęp do MUC przez IRC</homepage>, <homepage url="http://ejabberd.im/ejabberd_users">zapis informacji użytkowników do HTML</homepage>, <homepage url="http://ejabberd.im/mod_logxml">logowanie pakietów jako XML</homepage>, <homepage url="http://ejabberd.im/mod_filter">filtrowanie dostępu</homepage>. Ciekawe wydają się także moduły do współpracy z serwerem <id_link id="USAGE:network_services:voip">VoIP</id_link> Asterisk - <homepage url="http://ejabberd.im/mod_asterisk">mod_asterisk</homepage> i <homepage url="http://ejabberd.im/mod_client_asterisk">mod_client_asterisk</homepage>.</p>

<p>Wiecej patchy znaleźć można na: <homepage url="http://www.ejabberd.im/contributions">ejabberd.im</homepage>. Wiele z opisywanych łatek jest do pobrania poprzez: <code>svn co https://svn.process-one.net/ejabberd-modules</code> i budowane są one niezależnie od samego ejabberda. Jednak patche mojega autorstwa związane z <id_link id="ejabberd_aliases">aliasami JID</id_link> ("ejabberd_log_offline_message.diff" i "ejabberd_alias_forward.diff") wymagają pobrania źródeł ejabberda (<code>apt-get source ejabberd</code>) zapatchowania go (<code>cd ejabberd-*/src; patch -p0 &lt; ../../ejabberd_*.diff</code>) i zbudowania (<code>./configure &amp;&amp; make</code> lub <code>cd ..; dpkg-buildpackage -rfakeroot</code>).</p>

<p>Polecam także mój system <id_link id="xmpp_smtp">powiadomień XMPP/SMTP</id_link> zawierający m.in. łatką "ejabberd_log_offline_message.diff" powodującą zapisywanie wiadomości trybu offline także do plików tekstowych, które wykorzystuje w moim systemie do przesyłania powiadomień o nowych IM na e-mail. Zachęcam także do zapoznania się z zestawem moich patch'y do serwera ejabberd implementujących <id_link id ="ejabberd_aliases">JID aliases</id_link>.</p>

<p>Innymi wartymi zainteresowania uzupełnieniami serwera xmpp są z pewnością: transport <homepage url="http://wiki.jrudevels.org/index.php/Eng:J2J:AdminGuide">xmpp2xmpp</homepage> (ułatwia on między innymi bycie on-line na kilku kontach równocześnie, korzystanie z adresu na innym serwerze i usług takich jak archiwizacja na innym - JID aliasing) oraz system prezentacji i zarządzania historią rozmów - <homepage url="http://www.planeta.toliman.pl/search/label/Jorge">Jorge</homepage>.</p>

<p>Przy konfiguracji warto zwrócić uwagę na dostęp do MUC (polecam ustawienie umożliwiające udział każdemu a zakładanie tylko swoim - <code>{mod_muc,  [{access, muc}, {access_create, muc_create}, {access_admin, muc_admin}]  }</code>, polecam ustawić także: <code>{access, muc_admin, [{allow, admin}]}. {access, muc_create, [{allow, local}]}. {access, muc, [{allow, all}]}.</code>. Jeżeli nasz system kożysta z IPv6 należy uruchomić słuchania na tym protkole - wpisy inet6 w konfiguracji portów nasłuchiwania np.: <code>{5222, ejabberd_c2s, [inet6, {access, c2s}, <var>....</var>]}</code>.
	W przypadku kożystania z autoryzacji przez PAM (wpis konfiguracyjny <code>{auth_method, pam}.</code>) konieczne może okazać się dodanie użytkownika ejabberd do grupy shadow, warto wtedy także wyłączyć możliwość rejestracji - <code>{access, register, [{deny, all}]}.</code>. Przykładowy konfig: <a class="int" href="./ejabberd.cfg">ejabberd.cfg</a>.</p>

<p>Niekiedy (gdy za dużo napsujemy) mogą wystąpić problemy z startem ejabberd'a. Należy wtedy wyeksportować dane konfiguracyjne z jego bazy (<code>ejabberdctl dump</code>), zatrzymać ejabberda, usunąć <kbd class="path">/var/lib/ejabberd</kbd> i po ponownym uruchomieniu ejabberda przywrócić z pliku tekstowego(<code>ejabberdctl load</code>). Można także bawić się z podmianą wybranych plików w tym katalogu, jest to przydatne tylko gdy nie możemy uruchomić ejabberd'a a nie posiadamy zrzutu - przenosimy wtedy ten katalog w inne miejsce, odpalamy ejabberda, zatrzymujemy go, pliki LATEST.LOG config.DCD local_config.DCD disco_publish.DAT z nowo utworzonego katalogu kopiujemy do starego, zastępujemy nim nowy i odpalamy ejabberda. Ta metoda w odróżnieniu od pierwszej regeneruje bazę jednorazowo, więc przy następnym starcie też będzie problem.<br />
	Jeszcze innym (i chyba najlepszym) rozwiązaniem tych problemów jest wywalenie zawartości <kbd class="path">/var/lib/ejabberd</kbd>, odpalenie w celu uzyskania nowego konfigu, przywrócenie poprzedniej zawartości <kbd class="path">/var/lib/ejabberd</kbd> i zrobienie <code>cd /path/do/zarhiwizowanego/_nowego_/var/lib/ejabberd/ &amp;&amp; cp /tmp/ejabberd/config.DCD /tmp/ejabberd/local_config.DCD /tmp/ejabberd/disco_publish.DAT /var/lib/ejabberd/; chown ejabberd:ejabberd /var/lib/ejabberd/*; /etc/init.d/ejabberd start</code></p>

<p>Interesującym rozwiązaniem jest także dobrze współpracujący z ejabberd webowy klient xmpp - jwchat. Korzysta on z mechanizmu HTTP Binding (lub HTTP Polling) oprócz włączenia tych mechanizmów w ejabberd (moduł mod_http_bind oraz odpowiednia konfiguracja ejabberd_http) i ustawienia dla nich proxy (m.in. po to aby puszczać to po https) należy szczególną uwagę zwrócić na to iż w url występuje - a w konfiguracji mod_http_bind występuje _.</p>

<p>Zobacz także: <homepage url="http://bepointbe.be/jabwebhist/">Jabber archive web reader</homepage>, <a class="ext" href="http://www.ejabberd.im/protocols">wykaz rozszerzeń / protokołów wspieranych przez ejabberd</a>, <homepage url="http://xmpp.org/extensions/">wykaz rozszerzeń protokołu (dokumentów XEP)</homepage>, XEP-0209: Metacontacts, XEP-0153: vCard-Based Avatars.</p>
</article>
